{% extends "PatentMS/base_model.html" %} 
{% load static %}

{% block title_block%}
    {{ category.name}}
{% endblock %}
{% block body_block %}
    {% if category %}
    <body data-category-id="{{ category.id }}">
        <div class="jumbotron p-4">
  <div class="container">
    <h1 class="jumbotron-heading">{{ category.name }}</h1>
    <div>
      <h2 class="h2">
        {% if user.is_authenticated %}
          欢迎，{{ user.username }}
        {% else %}
          请先登录
        {% endif %}
      </h2>
    </div>
  </div>
</div>
        <div id="pages-container">
            {% if pages%}
                <ul>
                    <h2>页面列表</h2>
                    {% for page in pages%}
                         <li>
                            <a href="{% url 'goto' %}?page_id={{page.id}}">{{page.title}}</a>
                            - {{page.views}} view{% if page.views != 1%}s{%  endif %}
                        </li> 
                    {% endfor %}
                </ul>
            {% else %}
                <strong>当前页面无pages</strong>
            {% endif %}
        </div>
        
        <!-- 搜索功能区域 -->
        {% if user.is_authenticated %}
        <div class="mt-4">
            <h3>搜索并添加页面</h3>
            <div class="input-group mb-3">
                <input type="text" id="search-query" class="form-control" placeholder="输入搜索关键词...">
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" id="search-btn">搜索</button>
                </div>
            </div>
            <div id="search-results"></div>
        </div>
        {% endif %}
        <a href="{% url "index" %}">返回主页</a>
    {% else %}
            特定分类不存在
    {% endif %}
    <div>
        <strong id = "like_count">{{ category.likes}}</strong>点赞
            {% if user.is_authenticated %}
            <button id = "like_btn"
                data-categoryid="{{ category.id }}"
                class = "btn btn-primary btn-sm"
                type = "button">
                <span data-feather="thumbs-up"></span>
                点赞分类
            </button>
            {% endif %}
    </div>

    <!-- 内联jQuery代码处理点赞功能 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
    $(document).ready(function() {
        console.log("Category页面jQuery加载成功");
        
        // 点赞功能
        $("#like_btn").click(function() {
            console.log("点赞按钮被点击");
            var categoryIdVar = $(this).attr("data-categoryid");
            console.log("分类ID:", categoryIdVar);
            
            $.get("/like_category/", { category_id: categoryIdVar }, function(data) {
                console.log("点赞成功，返回数据:", data);
                $("#like_count").html(data);
                $("#like_btn").hide();
            }).fail(function(xhr, status, error) {
                console.error("点赞失败:", error);
                alert("点赞失败: " + error);
            });
        });
        
        // 搜索建议功能
        $("#search-input").keyup(function() {
            var query = $(this).val();
            $.get("/suggest/", { suggestion: query }, function(data) {
                $("#categories-listing").html(data);
            });
        });
        
        // 搜索和添加页面功能
        $("#search-btn").click(function() {
            var query = $("#search-query").val();
            if (query.trim() === "") {
                alert("请输入搜索关键词");
                return;
            }
            
            var mockResults = [
                { title: query + " 教程", url: "https://example.com/tutorial" },
                { title: query + " 文档", url: "https://example.com/docs" },
                { title: query + " 指南", url: "https://example.com/guide" },
            ];
            
            displaySearchResults(mockResults);
        });
        
        function displaySearchResults(results) {
            var html = '<div class="mt-3"><h4>搜索结果:</h4><ul class="list-group">';
            results.forEach(function(result) {
                html += '<li class="list-group-item d-flex justify-content-between align-items-center">';
                html += '<div><a href="' + result.url + '" target="_blank">' + result.title + "</a></div>";
                html += '<button class="btn btn-success btn-sm add-page-btn" ' +
                    'data-title="' + result.title + '" ' +
                    'data-url="' + result.url + '">添加</button>';
                html += "</li>";
            });
            html += "</ul></div>";
            $("#search-results").html(html);
        }
        
        // 添加页面按钮事件
        $(document).on("click", ".add-page-btn", function() {
            var title = $(this).data("title");
            var url = $(this).data("url");
            var categoryId = $("body").data("category-id") || "1";
            
            $.get("/search_add_page/", {
                title: title,
                url: url,
                category_id: categoryId,
            }, function(data) {
                $("#pages-container").html(data);
                $("#search-results").html('<div class="alert alert-success">页面添加成功！</div>');
            }).fail(function(xhr, status, error) {
                alert("添加页面失败: " + error);
            });
        });
    });
    </script>

{% endblock %} 

